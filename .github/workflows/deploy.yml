name: Frontend CI/CD Docker Deploy to EC2

on:
  push:
    branches: [ hotfix2 ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
     # 1. GitHub ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

       # 2. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}     

      # 3. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ - front
      - name: Build & Push front-service
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/front-service:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/front-service:${{ github.sha }}       


      # 4. EC2ì— SSH ì ‘ì† & ë°°í¬
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/vybz/front-service

            echo "[1/6] í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±"
            # user .env.user ìƒì„±
            cat <<EOF > .env.user
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            BASE_URL=${{ secrets.BASE_URL }}
            BASE_API_URL=${{ secrets.BASE_API_URL }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
            EOF  

            # buskerìš© .env.busker ìƒì„±
            cat <<EOF > .env.busker
            NEXTAUTH_URL=${{ secrets.BUSKER_NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            BASE_URL=${{ secrets.BASE_URL }}
            BASE_API_URL=${{ secrets.BASE_API_URL }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
            EOF  
              
            docker-compose down
            docker-compose rm -f
            
            docker images "${{ secrets.DOCKER_HUB_USERNAME }}/front-service" --format "{{.ID}}" | uniq | tail -n +2 | xargs -r docker rmi -f
            
            docker image prune -af
            
            export FRONT_IMAGE_TAG=${{ github.sha }}

            docker-compose pull 

            docker-compose up -d front-user
            docker-compose up -d front-busker
            docker-compose up -d front-admin

      # 5-1. ì„±ê³µ ì‹œ ì•Œë¦¼
      - name: Send Discord Success Notification
        if: success()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FRONT }}
        with:
          args: |
            âœ… [${{ github.actor }}]ë‹˜ì´ `${{ github.repository }}` ë ˆí¬ì§€í† ë¦¬ì—ì„œ **ë°°í¬ë¥¼ ì™„ë£Œ**í–ˆì–´ìš”!
            ğŸ”— ì»¤ë°‹: ${{ github.sha }}

      # 5-2. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      - name: Send Discord Failure Notification
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FRONT }}
        with:
          args: |
            âŒ [${{ github.actor }}]ë‹˜ì´ `${{ github.repository }}` ë ˆí¬ì§€í† ë¦¬ì—ì„œ **ë°°í¬ì— ì‹¤íŒ¨**í–ˆì–´ìš”!
            ğŸ” ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
    